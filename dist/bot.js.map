{"version":3,"file":"bot.js","sourceRoot":"","sources":["../src/bot.ts"],"names":[],"mappings":"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","sourcesContent":["import Discord, { Interaction, GuildMember, Snowflake } from 'discord.js';\nimport {\n\tAudioPlayerStatus,\n\tAudioResource,\n\tentersState,\n\tjoinVoiceChannel,\n\tVoiceConnectionStatus,\n} from '@discordjs/voice';\nimport { Track } from './music/track';\nimport { MusicSubscription } from './music/subscription';\n\nimport English from \"./lang/english\";\nimport German from \"./lang/german\";\n\n// eslint-disable-next-line @typescript-eslint/no-var-requires, @typescript-eslint/no-require-imports\nconst { token } = require('../auth.json');\n\nconst client = new Discord.Client({ intents: ['GUILD_VOICE_STATES', 'GUILD_MESSAGES', 'GUILDS'] });\n\nclient.on('ready', () => console.log('Ready!'));\n\n// This contains the setup code for creating slash commands in a guild. The owner of the bot can send \"!deploy\" to create them.\nclient.on('messageCreate', async (message) => {\n\tif (!message.guild) return;\n\tif (!client.application?.owner) await client.application?.fetch();\n\n\tif (message.content.toLowerCase() === '!deploy' && message.author.id === client.application?.owner?.id) {\n\t\tawait message.guild.commands.set([\n\t\t\t{\n\t\t\t\tname: 'play',\n\t\t\t\tdescription: 'Plays a song',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'song',\n\t\t\t\t\t\ttype: 'STRING' as const,\n\t\t\t\t\t\tdescription: 'The YouTube URL of the song to play',\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'skip',\n\t\t\t\tdescription: 'Skip to the next song in the queue',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'queue',\n\t\t\t\tdescription: 'See the music queue',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'pause',\n\t\t\t\tdescription: 'Pauses the song that is currently playing',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'resume',\n\t\t\t\tdescription: 'Resume playback of the current song',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'leave',\n\t\t\t\tdescription: 'Leave the voice channel',\n\t\t\t},\n\t\t\t{\n\t\t\t\tname: 'test',\n\t\t\t\tdescription: 'test',\n\t\t\t},\n\t\t]);\n\n\t\tawait message.reply(English.COMMANDS_DEPLOY_SUCCESS);\n\t}\n});\n\n/**\n * Maps guild IDs to music subscriptions, which exist if the bot has an active VoiceConnection to the guild.\n */\nconst subscriptions = new Map<Snowflake, MusicSubscription>();\n\n// Handles slash command interactions\nclient.on('interactionCreate', async (interaction: Interaction) => {\n\tif (!interaction.isCommand() || !interaction.guildId) return;\n\tlet subscription = subscriptions.get(interaction.guildId);\n\n\tif (interaction.commandName === 'play') {\n\t\tawait interaction.reply(English.COMMANDS_PLAY_BUSY)\n\t\t// Extract the video URL from the command\n\t\tconst url = interaction.options.get('song')!.value! as string;\n\n\t\t// If a connection to the guild doesn't already exist and the user is in a voice channel, join that channel\n\t\t// and create a subscription.\n\t\tif (!subscription) {\n\t\t\tif (interaction.member instanceof GuildMember && interaction.member.voice.channel) {\n\t\t\t\tconst channel = interaction.member.voice.channel;\n\t\t\t\tsubscription = new MusicSubscription(\n\t\t\t\t\tjoinVoiceChannel({\n\t\t\t\t\t\tchannelId: channel.id,\n\t\t\t\t\t\tguildId: channel.guild.id,\n\t\t\t\t\t\tadapterCreator: channel.guild.voiceAdapterCreator,\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t\tsubscription.voiceConnection.on('error', console.warn);\n\t\t\t\tsubscriptions.set(interaction.guildId, subscription);\n\t\t\t}\n\t\t}\n\n\t\t// If there is no subscription, tell the user they need to join a channel.\n\t\tif (!subscription) {\n\t\t\tawait interaction.followUp(English.ERRORS_SUBSCRIPTION_NONE);\n\t\t\treturn;\n\t\t}\n\n\t\t// Make sure the connection is ready before processing the user's request\n\t\ttry {\n\t\t\tawait entersState(subscription.voiceConnection, VoiceConnectionStatus.Ready, 20e3);\n\t\t} catch (error) {\n\t\t\tconsole.warn(error);\n\t\t\tawait interaction.followUp(English.ERRORS_SUBSCRIPTION_TIMEOUT);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Attempt to create a Track from the user's video URL\n\t\t\tconst track = await Track.from(url, {\n\t\t\t\tonStart() {\n\t\t\t\t\tinteraction.followUp({ content: English.COMMANDS_PLAY_FOLLOWUP_START, ephemeral: true }).catch(console.warn);\n\t\t\t\t},\n\t\t\t\tonFinish() {\n\t\t\t\t\tinteraction.followUp({ content: English.COMMANDS_PLAY_FOLLOWUP_END, ephemeral: true }).catch(console.warn);\n\t\t\t\t},\n\t\t\t\tonError(error) {\n\t\t\t\t\tconsole.warn(error);\n\t\t\t\t\tinteraction.followUp({ content: `${English.COMMANDS_PLAY_FOLLOWUP_ERROR}${error.message}`, ephemeral: true }).catch(console.warn);\n\t\t\t\t},\n\t\t\t});\n\t\t\t// Enqueue the track and reply a success message to the user\n\t\t\tsubscription.enqueue(track);\n\t\t\tawait interaction.followUp(`${English.COMMANDS_PLAY_DONE}**${track.title}**`);\n\t\t} catch (error) {\n\t\t\tconsole.warn(error);\n\t\t\tawait interaction.reply(English.COMMANDS_PLAY_ERROR);\n\t\t}\n\t} else if (interaction.commandName === 'skip') {\n\t\tif (subscription) {\n\t\t\t// Calling .stop() on an AudioPlayer causes it to transition into the Idle state. Because of a state transition\n\t\t\t// listener defined in music/subscription.ts, transitions into the Idle state mean the next track from the queue\n\t\t\t// will be loaded and played.\n\t\t\tsubscription.audioPlayer.stop();\n\t\t\tawait interaction.reply(English.COMMANDS_SKIP_SUCCESS);\n\t\t} else {\n\t\t\tawait interaction.reply(English.COMMANDS_SKIP_NOSUBSCRIPTION);\n\t\t}\n\t} else if (interaction.commandName === 'queue') {\n\t\t// Print out the current queue, including up to the next 5 tracks to be played.\n\t\tif (subscription) {\n\t\t\tconst current =\n\t\t\t\tsubscription.audioPlayer.state.status === AudioPlayerStatus.Idle\n\t\t\t\t\t? English.COMMANDS_QUEUE_EMPTY\n\t\t\t\t\t: `${English.COMMANDS_QUEUE_PLAYING}**${(subscription.audioPlayer.state.resource as AudioResource<Track>).metadata.title}**`;\n\n\t\t\tconst queue = subscription.queue\n\t\t\t\t.slice(0, 5)\n\t\t\t\t.map((track, index) => `${index + 1}) ${track.title}`)\n\t\t\t\t.join('\\n');\n\n\t\t\tawait interaction.reply(`${current}\\n\\n${queue}`);\n\t\t} else {\n\t\t\tawait interaction.reply(English.COMMANDS_QUEUE_NOSUBSCRIPTION);\n\t\t}\n\t} else if (interaction.commandName === 'pause') {\n\t\tif (subscription) {\n\t\t\tsubscription.audioPlayer.pause();\n\t\t\tawait interaction.reply({ content: English.COMMANDS_PAUSE_SUCCESS, ephemeral: true });\n\t\t} else {\n\t\t\tawait interaction.reply(English.COMMANDS_PAUSE_NOSUBSCRIPTION);\n\t\t}\n\t} else if (interaction.commandName === 'resume') {\n\t\tif (subscription) {\n\t\t\tsubscription.audioPlayer.unpause();\n\t\t\tawait interaction.reply({ content: English.COMMANDS_RESUME_SUCCESS, ephemeral: true });\n\t\t} else {\n\t\t\tawait interaction.reply(English.COMMANDS_RESUME_NOSUBSCRIPTION);\n\t\t}\n\t} else if (interaction.commandName === 'leave') {\n\t\tif (subscription) {\n\t\t\tsubscription.voiceConnection.destroy();\n\t\t\tsubscriptions.delete(interaction.guildId);\n\t\t\tawait interaction.reply({ content: English.COMMANDS_LEAVE_SUCCESS, ephemeral: true });\n\t\t} else {\n\t\t\tawait interaction.reply(English.COMMANDS_LEAVE_NOSUBSCRIPTION);\n\t\t}\n\t} else {\n\t\tawait interaction.reply(English.ERRORS_INTERACTION_UNKNOWN);\n\t}\n});\n\nclient.on('error', console.warn);\n\nvoid client.login(token);\n"]}